# Neptune 自动充电脚本

自动检测昨晚断电的充电桩，并在早上自动恢复充电。

## 功能

- 检测昨天 23:45 - 00:15 之间因断电结束的充电记录
- 自动在同一设备/端口恢复充电
- 按余额最大化充电，最长 480 分钟
- **智能重试**：失败后 10 分钟重试，最多 3 次

## 部署方式

### 方式一：GitHub Actions（推荐，无需服务器）

1. **Fork 本仓库**

2. **配置 Secrets**

   进入你的仓库 → Settings → Secrets and variables → Actions → New repository secret

   添加以下 Secrets：

   | Name | Value |
   |------|-------|
   | `NEPTUNE_OPEN_ID` | 你的 openId |
   | `NEPTUNE_AREA_ID` | 6 |
   | `NEPTUNE_EMPLOYEE_ID` | 你的 employeeId |

3. **启用 Actions**

   进入 Actions 标签页，点击 "I understand my workflows, go ahead and enable them"

4. **测试运行**

   Actions → Neptune Auto Charge → Run workflow → Run workflow

   脚本会在每天北京时间 **6:05** 自动运行。

### 方式二：VPS 定时任务

```bash
# 克隆仓库
git clone https://github.com/你的用户名/neptune-auto-charger.git
cd neptune-auto-charger

# 安装依赖
pip install -r requirements.txt

# 配置
cp .env.example .env
nano .env  # 编辑填写你的信息

# 设置定时任务
crontab -e
# 添加：
5 6 * * * cd /path/to/neptune-auto-charger && python3 main.py >> charge.log 2>&1
```

## 配置说明

| 变量 | 说明 | 获取方式 |
|------|------|---------|
| `NEPTUNE_OPEN_ID` | 微信用户标识 | 抓包获取 |
| `NEPTUNE_AREA_ID` | 区域 ID | 固定为 6 |
| `NEPTUNE_EMPLOYEE_ID` | 用户 ID | 抓包获取 |

### 如何获取这些信息？

1. 使用抓包工具（Fiddler/Charles）抓取微信小程序请求
2. 找到 `www.szlzxn.cn` 的请求
3. 从请求参数中获取 `openId` 和 `employeeId`

## 本地测试

```bash
# 安装依赖
pip install -r requirements.txt

# 配置
cp .env.example .env
# 编辑 .env 填写你的信息

# 运行
python main.py
```

## 运行示例

```
[2025-12-22 06:05:00] ==================================================
[2025-12-22 06:05:00] Neptune 自动充电脚本启动
[2025-12-22 06:05:00] 重试策略: 最多 3 次，间隔 10 分钟
[2025-12-22 06:05:00] ==================================================
[2025-12-22 06:05:00]
--- 第 1/3 次尝试 ---
[2025-12-22 06:05:00] 获取用户信息...
[2025-12-22 06:05:00] 当前余额: 6.99 元
[2025-12-22 06:05:01] 获取 202512 充电历史...
[2025-12-22 06:05:01] 共获取 10 条充电记录
[2025-12-22 06:05:01] 检查断电记录...
[2025-12-22 06:05:01] 检测时间窗口: 2025-12-21 23:45 ~ 2025-12-22 00:15
[2025-12-22 06:05:01] 找到断电记录: 设备=50559154, 端口=10, 结束时间=2025-12-22 00:05:07
[2025-12-22 06:05:01] 获取设备 50559154 信息...
[2025-12-22 06:05:01] 端口状态: 000000000000
[2025-12-22 06:05:01] 端口 10 空闲，准备充电
[2025-12-22 06:05:02] 启动充电: 设备=50559154, 端口=10, 金额=6.99元
[2025-12-22 06:05:02] ==================================================
[2025-12-22 06:05:02] 充电启动成功！
[2025-12-22 06:05:02] ==================================================
```

## 重试策略

- **6:05** 第一次尝试
- **6:15** 第二次尝试（如果第一次失败）
- **6:25** 第三次尝试（如果第二次失败）

如果充电桩 6 点准时开启但系统有延迟，重试机制可以确保充电成功。

## 注意事项

- 脚本只会恢复**昨晚断电**的充电，不会触发前天的记录
- 保持余额充足（至少 1 元）
- `openId` 相当于你的账户密码，请妥善保管
